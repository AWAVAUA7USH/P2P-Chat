<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Manual Setup Chat</title>
    <style>
        #controls {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h2>WebRTC Chat with Manual Setup</h2>
    
    <div id="controls">
        <label for="peerIp">Peer IP:</label>
        <input id="peerIp" type="text" placeholder="Enter peer IP" style="width: 200px;"><br>
        <button id="setup">Setup Connection</button>
    </div>
    
    <textarea id="messages" readonly style="width: 100%; height: 200px;"></textarea><br>
    <input id="message" type="text" placeholder="Type a message..." style="width: 100%;"><br>
    <button id="send">Send</button>

    <script>
        const PORT = 5000; // Hardcoded port number
        let peerConnection;
        let dataChannel;

        function createPeerConnection() {
            const configuration = {
                iceServers: []  // No STUN/TURN server needed for local network
            };

            peerConnection = new RTCPeerConnection(configuration);

            // Predefined ICE candidate and SDP setup
            const peerIp = document.getElementById('peerIp').value;
            if (!peerIp) {
                alert('Please enter an IP address');
                return;
            }

            const predefinedIceCandidate = new RTCIceCandidate({
                candidate: `candidate:1 1 UDP 2122260223 ${peerIp} ${PORT} typ host`,
                sdpMid: 'data',
                sdpMLineIndex: 0
            });

            peerConnection.addIceCandidate(predefinedIceCandidate);

            const sdp = `v=0
o=- 0 0 IN IP4 127.0.0.1
s=-
t=0 0
m=application ${PORT} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:data
a=sctpmap:${PORT} webrtc-datachannel 256
`;

            peerConnection.setLocalDescription({ type: 'offer', sdp: sdp });
            peerConnection.setRemoteDescription({ type: 'answer', sdp: sdp });

            dataChannel = peerConnection.createDataChannel("chat");

            dataChannel.onopen = () => {
                console.log('Data channel is open');
            };

            dataChannel.onmessage = (event) => {
                const messagesTextarea = document.getElementById('messages');
                messagesTextarea.value += `Remote: ${event.data}\n`;
            };
        }

        document.getElementById('setup').addEventListener('click', () => {
            createPeerConnection();
        });

        document.getElementById('send').addEventListener('click', () => {
            const message = document.getElementById('message').value;
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                document.getElementById('messages').value += `Local: ${message}\n`;
                document.getElementById('message').value = '';
            } else {
                alert('Data channel is not open.');
            }
        });
    </script>
</body>
</html>
